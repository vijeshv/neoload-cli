pipeline {
  agent any

  parameters {
    string(defaultValue: "${NLWEBToken}", description: 'Neoload Web Token', name: 'token')
    string(defaultValue: "defaultzone", description: 'Zone identifier', name: 'zone_id')
    string(defaultValue: "https://neoload-api.saas.neotys.com/", description: 'NeoLoad Web Api Url', name: 'api_url')
  }

  stages {
    stage('Attach Worker') {   
        environment {
        NEOLOAD="${WORKSPACE}/neoload"
        HOME="${WORKSPACE}"
      }
      stages {
        stage('Get NeoLoad CLI') {
          steps {
              bat "pip3 install -U  neoload"
              bat "$NEOLOAD --version"
          }
        }
        stage('Get NeoLoad project'){
            steps {
                bat 'rm -f *.yml; wget https://raw.githubusercontent.com/Neotys-Labs/neoload-cli/master/tests/neoload_projects/simpledemo.yml'
            }
        }
        stage('Prepare NeoLoad test') {
          steps {
              bat """$NEOLOAD \
                     login --url ${params.api_url} ${params.token} \
                     test-settings --zone ${params.zone_id} --lgs 1 --scenario 'simpledemo' createorpatch "My Jenkins Test With CLI" \
                     project --path simpledemo.yml upload
                """
          }
        }
        stage('Run Test') {
          steps {
              bat """$NEOLOAD run \
                  --name "Jenkins pipeline performance regression test ${BUILD_NUMBER}" \
                  --external-url '${BUILD_URL}' \
                  --external-url-label 'Jenkins build ${BUILD_NUMBER}' \
                  --description "Jenkins result description" \
                  --return-0 \
                  --web-vu 50 \
                 """
          }
        }
        stage('Generate Test Report') {
          steps {
             bat "$NEOLOAD test-results junitsla"
          }
          post {
              always {
                  junit 'junit-sla.xml'
              }
          }
        }
      }
    }
  }
}
